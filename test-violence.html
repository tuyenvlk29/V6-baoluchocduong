<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kh·∫£o s√°t B·∫°o l·ª±c h·ªçc ƒë∆∞·ªùng - Th·ªè Ng·ªçc</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .question-item {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .options {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .option-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 18%;
            text-align: center;
            font-size: 0.9rem;
        }

        .option-label input {
            margin-bottom: 0.5rem;
        }

        #result-section {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .score-display {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-blue);
            margin: 1rem 0;
        }

        .feedback-text {
            font-size: 1.2rem;
            margin-bottom: 2rem;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-left">
            <a href="topics.html" class="header-button">Quay l·∫°i</a>
        </div>
        <div class="logo">
            <a href="index.html" style="text-decoration:none;">
                <img src="https://lqdlbt.igcschool.edu.vn/Data/Sites/17/media/logo-web---lqdlbt-trang-png-72.png"
                    alt="Logo" id="logo">
            </a>
        </div>
        <div class="header-right">
            <a href="login.html" class="header-button">ƒêƒÉng xu·∫•t</a>
        </div>
    </header>

    <main class="container" style="max-width: 800px;">
        <h2 style="text-align: center; margin: 2rem 0; color: var(--primary-blue);">Kh·∫£o S√°t B·∫°o L·ª±c H·ªçc ƒê∆∞·ªùng</h2>
        <p style="text-align: center; margin-bottom: 2rem; color: #666;">Vui l√≤ng tr·∫£ l·ªùi c√°c c√¢u h·ªèi d∆∞·ªõi ƒë√¢y ƒë·ªÉ gi√∫p
            ch√∫ng t√¥i hi·ªÉu th√™m v·ªÅ c·∫£m x√∫c v√† h√†nh vi c·ªßa b·∫°n. ƒê√°nh gi√° m·ªói c√¢u h·ªèi t·ª´ 1 ƒë·∫øn 5, v·ªõi 1 l√† 'Ho√†n to√†n
            kh√¥ng ƒë√∫ng' v√† 5 l√† 'R·∫•t ƒë√∫ng'.</p>
        <p style="text-align: center; margin-bottom: 2rem; font-style: italic;">1: Ho√†n to√†n kh√¥ng ƒë√∫ng | 2: Kh√¥ng ƒë√∫ng
            l·∫Øm |
            3: Trung b√¨nh | 4: Kh√° ƒë√∫ng | 5: R·∫•t ƒë√∫ng</p>

        <form id="survey-form">
            <!-- Questions generated by JS for brevity in this artifact, but I will write them out fully to ensure correctness -->
            <div id="questions-container"></div>

            <div style="text-align: center; margin-top: 2rem;">
                <button type="submit" class="btn" style="padding: 1rem 3rem; font-size: 1.2rem;">Ho√†n th√†nh kh·∫£o
                    s√°t</button>
            </div>
        </form>

        <div id="result-section">
            <h2 style="color: var(--primary-blue); margin-bottom: 1rem;">K·∫øt Qu·∫£ Tr·∫Øc Nghi·ªám</h2>
            <p style="margin-bottom: 2rem; color: #555;">D∆∞·ªõi ƒë√¢y l√† k·∫øt qu·∫£ tr·∫Øc nghi·ªám c·ªßa b·∫°n. H√£y ƒë·ªçc v√† tham kh·∫£o √Ω
                ki·∫øn t∆∞ v·∫•n t·ª´ c√°c chuy√™n gia c·ªßa ch√∫ng t√¥i.</p>

            <div class="score-display"
                style="font-size: 2.5rem; color: var(--primary-blue); font-weight: bold; margin-bottom: 1rem;">
                T·ªïng ƒëi·ªÉm c·ªßa b·∫°n l√†: <span id="score-value">0</span>
            </div>

            <p class="feedback-text"
                style="font-size: 1.1rem; line-height: 1.6; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; text-align: left;">
                Feedback here
            </p>

            <div style="margin-top: 2rem; display: flex; justify-content: center; gap: 1rem;">
                <button onclick="location.reload()" class="btn">Quay l·∫°i tr·∫Øc nghi·ªám</button>
                <a href="topics.html" class="header-button" style="color: var(--primary-blue); background: #eee;">V·ªÅ
                    danh s√°ch ch·ªß ƒë·ªÅ</a>
            </div>
        </div>
    </main>

    <!-- Chatbot Popup for High Risk -->
    <div id="urgent-popup"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; width: 90%; max-width: 400px; padding: 2rem; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.3); text-align: center; z-index: 2000; border: 2px solid var(--danger-color);">
        <h3 style="color: var(--primary-blue); margin-bottom: 1rem;">Th·ªè Ng·ªçc ‚Äì Chuy√™n gia t∆∞ v·∫•n t√¢m l√Ω</h3>
        <p style="margin-bottom: 1.5rem;">H√£y li√™n h·ªá qua s·ªë ƒëi·ªán tho·∫°i 0396390048 ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ th√™m.</p>
        <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <p style="font-weight: bold;">T·ªïng ƒë√†i h·ªó tr·ª£ t√¢m l√Ω</p>
            <p style="font-size: 1.5rem; color: var(--danger-color); font-weight: bold;">0396 390 048</p>
        </div>
        <button onclick="document.getElementById('urgent-popup').style.display='none'" class="btn">ƒê√≥ng</button>
    </div>

    <script>
        const questions = [
            "T√¥i b·ªã b·ª±c b·ªôi d·ªÖ d√†ng.",
            "T√¥i th∆∞·ªùng n√≥ng gi·∫≠n.",
            "Khi t·ª©c gi·∫≠n, t√¥i d·ªÖ n·ªïi xung v·ªõi ng∆∞·ªùi kh√°c.",
            "T√¥i nghƒ© r·∫±ng n·∫øu ai ƒë√≥ x√∫c ph·∫°m m√¨nh, h·ªç ƒë√°ng b·ªã ƒë√°nh l·∫°i.",
            "T√¥i n√≥i nh·ªØng l·ªùi n·∫∑ng n·ªÅ khi t·ª©c gi·∫≠n.",
            "T√¥i kh√≥ ki·ªÉm so√°t c∆°n gi·∫≠n c·ªßa m√¨nh.",
            "T√¥i c·∫£m th·∫•y h·ªëi ti·∫øc sau khi n·ªïi gi·∫≠n.",
            "T√¥i th∆∞·ªùng xuy√™n c·∫£m th·∫•y c√°u k·ªânh.",
            "Khi th·∫•t v·ªçng, t√¥i c√≥ th·ªÉ h√©t l√™n ho·∫∑c ƒë·∫≠p ƒë·ªì.",
            "T√¥i cho r·∫±ng ƒë√°nh nhau ƒë√¥i khi l√† c·∫ßn thi·∫øt ƒë·ªÉ gi·∫£i quy·∫øt m√¢u thu·∫´n.",
            "T√¥i hay b·ª±c t·ª©c khi kh√¥ng ƒë∆∞·ª£c nh∆∞ √Ω.",
            "T√¥i t·ª©c gi·∫≠n khi ng∆∞·ªùi kh√°c c·∫£n tr·ªü m√¨nh.",
            "Khi b·ªã x√∫c ph·∫°m, t√¥i mu·ªën tr·∫£ ƒë≈©a ngay l·∫≠p t·ª©c.",
            "T√¥i c·∫£m th·∫•y c√≥ quy·ªÅn t·ª©c gi·∫≠n khi b·ªã ƒë·ªëi x·ª≠ t·ªá.",
            "T√¥i kh√¥ng tha th·ª© d·ªÖ d√†ng cho ng∆∞·ªùi ƒë√£ l√†m t√¥i t·ªïn th∆∞∆°ng.",
            "T√¥i nghƒ© m√¨nh th∆∞·ªùng n√≥ng t√≠nh h∆°n ng∆∞·ªùi kh√°c.",
            "T√¥i c·∫£m th·∫•y d·ªÖ c√°u h∆°n h·∫ßu h·∫øt m·ªçi ng∆∞·ªùi.",
            "T√¥i th∆∞·ªùng xuy√™n th·∫•y b·∫£n th√¢n c√≥ nh·ªØng √Ω nghƒ© hung hƒÉng.",
            "Khi t·ª©c gi·∫≠n, t√¥i c√≥ xu h∆∞·ªõng mu·ªën l√†m t·ªïn th∆∞∆°ng ng∆∞·ªùi kh√°c.",
            "T√¥i th·∫•y kh√≥ ki·ªÅm ch·∫ø c·∫£m x√∫c khi b·ªã k√≠ch ƒë·ªông."
        ];

        const container = document.getElementById('questions-container');

        questions.forEach((q, index) => {
            const div = document.createElement('div');
            div.className = 'question-item';
            div.innerHTML = `
                <p><strong>C√¢u ${index + 1}:</strong> ${q}</p>
                <div class="options">
                    <label class="option-label"><input type="radio" name="q${index}" value="1" required>1<br>Ho√†n to√†n kh√¥ng ƒë√∫ng</label>
                    <label class="option-label"><input type="radio" name="q${index}" value="2">2<br>Kh√¥ng ƒë√∫ng l·∫Øm</label>
                    <label class="option-label"><input type="radio" name="q${index}" value="3">3<br>Trung b√¨nh</label>
                    <label class="option-label"><input type="radio" name="q${index}" value="4">4<br>Kh√° ƒë√∫ng</label>
                    <label class="option-label"><input type="radio" name="q${index}" value="5">5<br>R·∫•t ƒë√∫ng</label>
                </div>
            `;
            container.appendChild(div);
        });

        document.getElementById('survey-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            let totalScore = 0;
            const formData = new FormData(this);
            let answeredCount = 0;
            const surveyResults = [];

            for (let pair of formData.entries()) {
                const qIndex = parseInt(pair[0].replace('q', ''));
                const answerValue = parseInt(pair[1]);
                totalScore += answerValue;
                answeredCount++;

                // Collect Question & Answer for AI
                surveyResults.push({
                    text: `Question: ${questions[qIndex]} - Answer: ${answerValue}/5`
                });
            }

            if (answeredCount < questions.length) {
                alert("Vui l√≤ng tr·∫£ l·ªùi t·∫•t c·∫£ c√°c c√¢u h·ªèi.");
                return;
            }

            // Hide form, show result
            document.getElementById('survey-form').style.display = 'none';
            const resultSection = document.getElementById('result-section');
            resultSection.style.display = 'block';

            const scoreDisplay = document.getElementById('score-value');
            const feedbackText = resultSection.querySelector('.feedback-text');

            scoreDisplay.textContent = totalScore;

            let category = "";
            let message = "";
            let color = "";

            if (totalScore <= 39) {
                category = "Th·∫•p (Low)";
                message = "Ch√∫c m·ª´ng b·∫°n! B·∫°n ƒëang ki·ªÉm so√°t c·∫£m x√∫c v√† h√†nh vi t·ªët. Tuy nhi√™n, n·∫øu b·∫°n c·∫ßn th√™m s·ª± h·ªó tr·ª£, ch√∫ng t√¥i lu√¥n s·∫µn s√†ng gi√∫p ƒë·ª°.";
                color = "var(--success-color)";
            } else if (totalScore <= 59) {
                category = "Trung b√¨nh (Average)";
                message = "B·∫°n c√≥ th·ªÉ ƒë√¥i l√∫c c·∫£m th·∫•y t·ª©c gi·∫≠n ho·∫∑c cƒÉng th·∫≥ng. H√£y ch√∫ √Ω v√† theo d√µi c·∫£m x√∫c c·ªßa m√¨nh. N·∫øu c·∫ßn s·ª± h·ªó tr·ª£ th√™m, ch√∫ng t√¥i lu√¥n s·∫µn s√†ng gi√∫p ƒë·ª°.";
                color = "#fbc02d";
            } else if (totalScore <= 79) {
                category = "Cao (High)";
                message = "B·∫°n th·ªÉ hi·ªán m·ªôt s·ªë d·∫•u hi·ªáu c·ªßa h√†nh vi hung hƒÉng v√† c·∫ßn s·ª± can thi·ªáp t√¢m l√Ω. H√£y ch·ªß ƒë·ªông t√¨m ki·∫øm s·ª± h·ªó tr·ª£ ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y.";
                color = "#f57c00";
            } else {
                category = "R·∫•t cao (Very High)";
                message = "Nguy c∆° h√†nh vi xung ƒë·ªôt r·∫•t cao. Ch√∫ng t√¥i khuy·∫øn kh√≠ch b·∫°n li√™n h·ªá v·ªõi c√°c chuy√™n gia ƒë·ªÉ nh·∫≠n s·ª± h·ªó tr·ª£ chuy√™n s√¢u. ƒê·ª´ng ng·∫ßn ng·∫°i, h√£y li√™n h·ªá qua s·ªë hotline: 0396390048.";
                color = "var(--danger-color)";

                // Trigger Popup
                setTimeout(() => {
                    document.getElementById('urgent-popup').style.display = 'block';
                }, 1000);
            }

            scoreDisplay.parentElement.style.color = color;

            // SAVE SCORE FOR CHATBOT AGENT
            localStorage.setItem('violenceTestScore', totalScore);

            // Initial Feedback
            let fullFeedback = `<strong>M·ª©c ƒë·ªô: ${category}</strong><br><br>${message}`;
            feedbackText.innerHTML = fullFeedback;
            window.scrollTo(0, 0);

            // --- GEMINI AI ANALYSIS ---
            feedbackText.innerHTML += `<br><br><div style="background:#f0f8ff; padding:1rem; border-radius:8px; border:1px solid #cce5ff;">
                <strong>üîç Th·ªè Ng·ªçc AI ƒëang ph√¢n t√≠ch chi ti·∫øt...</strong>
            </div>`;

            try {
                // SECURITY UPDATE: Using Backend Proxy
                const API_URL = 'http://localhost:3000/api/chat';

                const prompt = `Analyze the survey results for a high school student.
                Role: You are Th·ªè Ng·ªçc, a empathetic, non-judgmental school counselor.
                
                Context:
                - Total Score: ${totalScore} (Range: 20-100).
                - Risk Category: ${category}.
                
                Instructions:
                1. Tone: Warm, supportive, safe, and encouraging. Never be critical.
                2. If Risk is 'Low': Praise their positive mindset.
                3. If Risk is 'Average' or 'High': Acknowledge their feelings, normalize the struggle, and gently suggest talking to someone.
                4. If Risk is 'Relative High' or 'Very High': You MUST strongly but gently encourage seeking help. You MUST mention the hotline: "0396 390 048" in your response.
                5. Length: Keep it under 100 words.
                
                Student's Specific Answers:
                ${surveyResults.map(r => r.text).join('\n')}`;

                const payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: prompt }]
                    }]
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("API Failure");
                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;

                // Update UI with AI text
                feedbackText.innerHTML = `<strong>K·∫øt qu·∫£: ${category}</strong><br><br>${message}
                <br><br><div style="background:#f0f8ff; padding:1rem; border-radius:8px; border:1px solid #cce5ff;">
                    <strong style="color:var(--primary-blue);">üí¨ G√≥c nh√¨n t·ª´ Th·ªè Ng·ªçc AI:</strong><br><br>
                    ${aiText.replace(/\n/g, '<br>')}
                </div>`;

            } catch (error) {
                console.error("AI Analysis Failed", error);
                feedbackText.innerHTML = `<strong>K·∫øt qu·∫£: ${category}</strong><br><br>${message}
                <br><br><div style="color:#999; font-style:italic;">(Ch·ª©c nƒÉng ph√¢n t√≠ch AI hi·ªán ƒëang ngo·∫°i tuy·∫øn)</div>`;
            }
        });
    </script>
    <script src="chatbot.js"></script>
</body>

</html>